[Module Metadata]
AUTHOR=Sarah Edwards/mac4n6.com/@iamevltwin
MODULE_NOTES=Original time is adjusted using PLSTORAGEOPERATOR_EVENTFORWARD_TIMEOFFSET Table

[Database Metadata]
DATABASE=CurrentPowerlog.PLSQL
PLATFORM=IOS
VERSIONS=11

[Query Metadata]
QUERY_NAME=powerlog_app_usage
ACTIVITY=Application Usage
KEY_TIMESTAMP=ADJUSTED_TIMESTAMP

[SQL Query]
QUERY=
   SELECT
      DATETIME(SCREEN_STATE_TIMESTAMP + SYSTEM, 'unixepoch') AS ADJUSTED_TIMESTAMP,
      BUNDLEID AS BUNDLE_ID,
      APPROLE,
      DISPLAY,
      LEVEL,
      ORIENTATION,
      SCREENWEIGHT,
      DATETIME(SCREEN_STATE_TIMESTAMP, 'unixepoch') AS ORIGINAL_SCREEN_STATE_TIMESTAMP,
      DATETIME(TIME_OFFSET_TIMESTAMP, 'unixepoch') AS OFFSET_TIMESTAMP,
      SYSTEM AS TIME_OFFSET,
      SCREENSTATE_ID
   FROM
      (
         SELECT
            BUNDLEID,
            SCREENSTATE_ID,
            SCREEN_STATE_TIMESTAMP,
            TIME_OFFSET_TIMESTAMP,
            MAX(TIME_OFFSET_ID) as max_id,
            SYSTEM,
            APPROLE,
            DISPLAY,
            LEVEL,
            ORIENTATION,
            SCREENWEIGHT 
         FROM
            (
               SELECT
                  PLSCREENSTATEAGENT_EVENTFORWARD_SCREENSTATE.APPROLE AS APPROLE,
                  PLSCREENSTATEAGENT_EVENTFORWARD_SCREENSTATE.DISPLAY AS DISPLAY,
                  PLSCREENSTATEAGENT_EVENTFORWARD_SCREENSTATE.LEVEL AS LEVEL,
                  PLSCREENSTATEAGENT_EVENTFORWARD_SCREENSTATE.ORIENTATION AS ORIENTATION,
                  PLSCREENSTATEAGENT_EVENTFORWARD_SCREENSTATE.SCREENWEIGHT AS SCREENWEIGHT,
                  PLSCREENSTATEAGENT_EVENTFORWARD_SCREENSTATE.ID AS SCREENSTATE_ID,
                  PLSCREENSTATEAGENT_EVENTFORWARD_SCREENSTATE.TIMESTAMP AS SCREEN_STATE_TIMESTAMP,
                  PLSTORAGEOPERATOR_EVENTFORWARD_TIMEOFFSET.TIMESTAMP AS TIME_OFFSET_TIMESTAMP,
                  PLSTORAGEOPERATOR_EVENTFORWARD_TIMEOFFSET.ID AS TIME_OFFSET_ID,
                  PLSTORAGEOPERATOR_EVENTFORWARD_TIMEOFFSET.SYSTEM,
                  BUNDLEID 
               FROM
                  PLSCREENSTATEAGENT_EVENTFORWARD_SCREENSTATE 
                  LEFT JOIN
                     PLSTORAGEOPERATOR_EVENTFORWARD_TIMEOFFSET 
               WHERE
                  SCREEN_STATE_TIMESTAMP > TIME_OFFSET_TIMESTAMP 
            )
            AS SCREENSTATE 
         GROUP BY
            SCREENSTATE_ID 
      )