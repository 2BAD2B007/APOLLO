[Module Metadata]
AUTHOR=Sarah Edwards/mac4n6.com/@iamevltwin
MODULE_NOTES=Device Peripherals State

[Database Metadata]
DATABASE=CurrentPowerlog.PLSQL
PLATFORM=MACOS
VERSIONS=10.15

[Query Metadata]
QUERY_NAME=powerlog_device_state
ACTIVITY=Peripheral State
KEY_TIMESTAMP=ADJUSTED_TIMESTAMP

[SQL Query 10.15]
QUERY=
	SELECT
		DATETIME(TIMESTAMP + SYSTEM, 'UNIXEPOCH') AS ADJUSTED_TIMESTAMP,
		BUSVERSIONORSPEED AS 'BUS VERSION OR SPEED',
		DEVICENAME AS 'DEVICE NAME',
		DEVICETYPE AS 'DEVICE TYPE',
		ISBUILTIN AS 'IS BUILT IN',
		NOWCONNECTED AS 'NOW CONNECTED',
		PRODUCTID AS 'PRODUCT ID',
		REGISTERENTRYID AS 'REGISTRY ENTRY ID',
		THUNDERBOLTREVISIONID AS 'THUNDERBOLT REVISION ID',
		VENDORID AS 'VENDOR ID',
		DATETIME(TIMESTAMP, 'UNIXEPOCH') AS ORIGINAL_TIMESTAMP,
		DATETIME(TIME_OFFSET_TIMESTAMP, 'UNIXEPOCH') AS OFFSET_TIMESTAMP,
		SYSTEM AS TIME_OFFSET,
		TABLE_ID AS "PLPERIPHERALAGENT_EVENTFORWARD_DEVICESTATE TABLE ID"
	FROM
	(
	SELECT
		TABLE_ID,
		TIMESTAMP,
		TIME_OFFSET_TIMESTAMP,
		MAX(TIME_OFFSET_ID) AS MAX_ID,
		BUSVERSIONORSPEED,
		DEVICENAME,
		DEVICETYPE,
		ISBUILTIN,
		NOWCONNECTED,
		PRODUCTID,
		REGISTERENTRYID,
		THUNDERBOLTREVISIONID,
		VENDORID,
		SYSTEM
	FROM
	(
	SELECT
		PLPERIPHERALAGENT_EVENTFORWARD_DEVICESTATE.TIMESTAMP,
		PLPERIPHERALAGENT_EVENTFORWARD_DEVICESTATE.BUSVERSIONORSPEED,
		PLPERIPHERALAGENT_EVENTFORWARD_DEVICESTATE.DEVICENAME,
		PLPERIPHERALAGENT_EVENTFORWARD_DEVICESTATE.DEVICETYPE,
		PLPERIPHERALAGENT_EVENTFORWARD_DEVICESTATE.ISBUILTIN,
		PLPERIPHERALAGENT_EVENTFORWARD_DEVICESTATE.NOWCONNECTED,
		PLPERIPHERALAGENT_EVENTFORWARD_DEVICESTATE.PRODUCTID,
		PLPERIPHERALAGENT_EVENTFORWARD_DEVICESTATE.REGISTERENTRYID,
		PLPERIPHERALAGENT_EVENTFORWARD_DEVICESTATE.THUNDERBOLTREVISIONID,
		PLPERIPHERALAGENT_EVENTFORWARD_DEVICESTATE.VENDORID,
		PLPERIPHERALAGENT_EVENTFORWARD_DEVICESTATE.ID AS "TABLE_ID",
		PLSTORAGEOPERATOR_EVENTFORWARD_TIMEOFFSET.TIMESTAMP AS TIME_OFFSET_TIMESTAMP,
		PLSTORAGEOPERATOR_EVENTFORWARD_TIMEOFFSET.ID AS TIME_OFFSET_ID,
		PLSTORAGEOPERATOR_EVENTFORWARD_TIMEOFFSET.SYSTEM
	FROM
		PLPERIPHERALAGENT_EVENTFORWARD_DEVICESTATE 
	LEFT JOIN
		PLSTORAGEOPERATOR_EVENTFORWARD_TIMEOFFSET 
	)
	GROUP BY
	TABLE_ID 
         )