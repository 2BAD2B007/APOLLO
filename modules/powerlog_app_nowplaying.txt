[Module Metadata]
AUTHOR=Sarah Edwards/mac4n6.com/@iamevltwin
MODULE_NOTES=What app/service is playing something, or not.

[Database Metadata]
DATABASE=CurrentPowerlog.PLSQL
PLATFORMS=IOS
VERSIONS=10,11,12

[Query Metadata]
QUERY_NAME=powerlog_app_nowplaying
ACTIVITY=App Usage
KEY_TIMESTAMP=ADJUSTED_TIMESTAMP

[SQL Query 10,11,12]
QUERY=
   SELECT
      DATETIME(NOWPLAYING_TIMESTAMP + SYSTEM, 'unixepoch') AS ADJUSTED_TIMESTAMP,
      BUNDLEID AS "BUNDLE ID",
      CASE STATE 
         WHEN "0" THEN "OFF" 
         WHEN "1" THEN "ON" 
      END AS "STATE",
      DATETIME(TIME_OFFSET_TIMESTAMP, 'unixepoch') AS OFFSET_TIMESTAMP,
      SYSTEM AS TIME_OFFSET,
      NOWPLAYING_ID AS "PLAUDIOAGENT_EVENTFORWARD_NOWPLAYING TABLE ID" 
      FROM
      (
      SELECT
         NOWPLAYING_ID,
         NOWPLAYING_TIMESTAMP,
         TIME_OFFSET_TIMESTAMP,
         MAX(TIME_OFFSET_ID) AS MAX_ID,
         BUNDLEID,
         STATE,
         SYSTEM
      FROM
            (
         SELECT
            PLAUDIOAGENT_EVENTFORWARD_NOWPLAYING.TIMESTAMP AS NOWPLAYING_TIMESTAMP,
            BUNDLEID,
            STATE,
            PLAUDIOAGENT_EVENTFORWARD_NOWPLAYING.ID AS "NOWPLAYING_ID" ,
            PLSTORAGEOPERATOR_EVENTFORWARD_TIMEOFFSET.TIMESTAMP AS TIME_OFFSET_TIMESTAMP,
            PLSTORAGEOPERATOR_EVENTFORWARD_TIMEOFFSET.ID AS TIME_OFFSET_ID,
            PLSTORAGEOPERATOR_EVENTFORWARD_TIMEOFFSET.SYSTEM
         FROM
            PLAUDIOAGENT_EVENTFORWARD_NOWPLAYING
         LEFT JOIN
            PLSTORAGEOPERATOR_EVENTFORWARD_TIMEOFFSET 
            )
            AS NOWPLAYING_STATE 
        GROUP BY
         NOWPLAYING_ID 
      )