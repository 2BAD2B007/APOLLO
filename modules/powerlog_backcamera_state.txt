[Module Metadata]
AUTHOR=Sarah Edwards/mac4n6.com/@iamevltwin
MODULE_NOTES=Records when back camera is in use.

[Database Metadata]
DATABASE=CurrentPowerlog.PLSQL
PLATFORMS=IOS
VERSIONS=9

[Query Metadata]
QUERY_NAME=powerlog_backcamera_state
ACTIVITY=Device Status
KEY_TIMESTAMP=ADJUSTED_TIMESTAMP

[SQL Query 9]
QUERY=
   SELECT
      DATETIME(CAMERA_TIMESTAMP + SYSTEM, 'unixepoch') AS ADJUSTED_TIMESTAMP,
      BUNDLEID AS BUNDLE_ID,
      CASE STATE
         WHEN "0" THEN "OFF"
         WHEN "1" THEN "ON"
      END AS STATE,
      DATETIME(CAMERA_TIMESTAMP, 'unixepoch') AS ORIGINAL_CAMERA_TIMESTAMP,
      DATETIME(TIME_OFFSET_TIMESTAMP, 'unixepoch') AS OFFSET_TIMESTAMP,
      SYSTEM AS TIME_OFFSET,
      CAMERA_ID AS "PLCAMERAAGENT_EVENTFORWARD_BACKCAMERA TABLE ID"
   FROM
      (
      SELECT
         BUNDLEID,
         CAMERA_ID,
         CAMERA_TIMESTAMP,
         TIME_OFFSET_TIMESTAMP,
         MAX(TIME_OFFSET_ID) as max_id,
         SYSTEM,
         STATE
      FROM
         (
         SELECT
            PLCAMERAAGENT_EVENTFORWARD_BACKCAMERA.TIMESTAMP AS CAMERA_TIMESTAMP,
            PLCAMERAAGENT_EVENTFORWARD_BACKCAMERA.BUNDLEID,
            PLCAMERAAGENT_EVENTFORWARD_BACKCAMERA.STATE,
            PLCAMERAAGENT_EVENTFORWARD_BACKCAMERA.ID as "CAMERA_ID",
            PLSTORAGEOPERATOR_EVENTFORWARD_TIMEOFFSET.TIMESTAMP AS TIME_OFFSET_TIMESTAMP,
            PLSTORAGEOPERATOR_EVENTFORWARD_TIMEOFFSET.ID AS TIME_OFFSET_ID,
            PLSTORAGEOPERATOR_EVENTFORWARD_TIMEOFFSET.SYSTEM,
            BUNDLEID 
         FROM
            PLCAMERAAGENT_EVENTFORWARD_BACKCAMERA 
         LEFT JOIN
            PLSTORAGEOPERATOR_EVENTFORWARD_TIMEOFFSET  
            )
            AS CAMERASTATE 
         GROUP BY
            CAMERA_ID 
      )