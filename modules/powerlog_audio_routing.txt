[Module Metadata]
AUTHOR=Sarah Edwards/mac4n6.com/@iamevltwin
MODULE_NOTES=Power Log Audio Output (ie: Speaker/CarAudioOutput/HeadphonesBT) of different categories (ie: Audio/Video, VoiceCommand, MediaPlayback). 

[Database Metadata]
DATABASE=CurrentPowerlog.PLSQL
PLATFORMS=IOS
VERSIONS=9,10,11,12

[Query Metadata]
QUERY_NAME=powerlog_audio_routing
ACTIVITY=Device State
KEY_TIMESTAMP=ADJUSTED_TIMESTAMP

[SQL Query]
QUERY=
	SELECT
		DATETIME(AUDIOROUTE_TIMESTAMP + SYSTEM, 'unixepoch') AS ADJUSTED_TIMESTAMP,
		ACTIVEROUTE,
		CASE ACTIVE 
			WHEN "0" THEN "NO" 
			WHEN "1" THEN "YES" 
		END "ACTIVE", 
		ACTIVEPID AS "ACTIVE PID",
		OUTPUTCATEGORY AS "OUTPUT CATEGORY",
		HEADSETHASINPUT AS "HEADSET HAS INPUT",
		HEADPHONESCONNECTED AS "HEADPHONES CONNECTED",
		DATETIME(AUDIOROUTE_TIMESTAMP, 'unixepoch') AS ORIGINAL_AUDIOROUTE_TIMESTAMP,
		DATETIME(TIME_OFFSET_TIMESTAMP, 'unixepoch') AS OFFSET_TIMESTAMP,
		SYSTEM AS TIME_OFFSET,
		AUDIOROUTE_ID AS "PLAUDIOAGENT_EVENTFORWARD_ROUTING TABLE ID" 
	FROM
      (
		SELECT
			AUDIOROUTE_ID,
			AUDIOROUTE_TIMESTAMP,
			TIME_OFFSET_TIMESTAMP,
			MAX(TIME_OFFSET_ID) AS MAX_ID,
			ACTIVEROUTE,
			ACTIVE,
			ACTIVEPID,
			OUTPUTCATEGORY,
			HEADSETHASINPUT,
			HEADPHONESCONNECTED,
			SYSTEM
		FROM
            (
			SELECT
				PLAUDIOAGENT_EVENTFORWARD_ROUTING.TIMESTAMP AS AUDIOROUTE_TIMESTAMP,
				ACTIVEROUTE,
				ACTIVE, 
				ACTIVEPID,
				OUTPUTCATEGORY,
				HEADSETHASINPUT,
				HEADPHONESCONNECTED, 
				PLAUDIOAGENT_EVENTFORWARD_ROUTING.ID AS "AUDIOROUTE_ID" ,
				PLSTORAGEOPERATOR_EVENTFORWARD_TIMEOFFSET.TIMESTAMP AS TIME_OFFSET_TIMESTAMP,
				PLSTORAGEOPERATOR_EVENTFORWARD_TIMEOFFSET.ID AS TIME_OFFSET_ID,
				PLSTORAGEOPERATOR_EVENTFORWARD_TIMEOFFSET.SYSTEM
			FROM
				PLAUDIOAGENT_EVENTFORWARD_ROUTING
			LEFT JOIN
				PLSTORAGEOPERATOR_EVENTFORWARD_TIMEOFFSET
            )
            AS AUDIOROUTE_STATE 
		GROUP BY
			AUDIOROUTE_ID 
      )