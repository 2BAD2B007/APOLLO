[Module Metadata]
AUTHOR=Sarah Edwards/mac4n6.com/@iamevltwin
MODULE_NOTES=Volume Percentage

[Database Metadata]
DATABASE=CurrentPowerlog.PLSQL
PLATFORMS=IOS
VERSIONS=9,10,11

[Query Metadata]
QUERY_NAME=powerlog_device_volume
ACTIVITY=Device State
KEY_TIMESTAMP=ADJUSTED_TIMESTAMP

[SQL Query]
QUERY=
   	SELECT
		DATETIME(VOLUME_TIMESTAMP + SYSTEM, 'unixepoch') AS ADJUSTED_TIMESTAMP,
		VOLUME AS "VOLUME PERCENTAGE",
		CASE MUTED 
			WHEN "0" THEN "NO" 
			WHEN "1" THEN "YES" 
		END AS "MUTED",
		DATETIME(VOLUME_TIMESTAMP, 'unixepoch') AS ORIGINAL_VOLUME_TIMESTAMP,
		DATETIME(TIME_OFFSET_TIMESTAMP, 'unixepoch') AS OFFSET_TIMESTAMP,
		SYSTEM AS TIME_OFFSET,
		VOLUME_ID AS "PLAUDIOAGENT_EVENTFORWARD_OUTPUT TABLE ID" 
   	FROM
      (
		SELECT
			VOLUME_ID,
			VOLUME_TIMESTAMP,
			TIME_OFFSET_TIMESTAMP,
			MAX(TIME_OFFSET_ID) AS MAX_ID,
			VOLUME,
			MUTED,
			SYSTEM
		FROM
            (
			SELECT
				PLAUDIOAGENT_EVENTFORWARD_OUTPUT.TIMESTAMP AS VOLUME_TIMESTAMP,
				VOLUME,
				MUTED,
				PLAUDIOAGENT_EVENTFORWARD_OUTPUT.ID AS "VOLUME_ID" ,
				PLSTORAGEOPERATOR_EVENTFORWARD_TIMEOFFSET.TIMESTAMP AS TIME_OFFSET_TIMESTAMP,
				PLSTORAGEOPERATOR_EVENTFORWARD_TIMEOFFSET.ID AS TIME_OFFSET_ID,
				PLSTORAGEOPERATOR_EVENTFORWARD_TIMEOFFSET.SYSTEM
			FROM
				PLAUDIOAGENT_EVENTFORWARD_OUTPUT
			LEFT JOIN
				PLSTORAGEOPERATOR_EVENTFORWARD_TIMEOFFSET
            )
            AS VOLUME_STATE 
        GROUP BY
			VOLUME_ID 
      )